# API Gateway - DNA Certificate System

The API Gateway is the primary Node.js microservice responsible for orchestrating external traffic, managing Admin JWT authentication, issuing new certificates, generating verification URIs/QRs, and communicating directly with the internal Python Crypto Engine.

---

## üèóÔ∏è Architecture Stack
*   **Runtime:** Node.js (ES6 Modules)
*   **Framework:** Express.js (v4)
*   **Database:** MongoDB Atlas (Mongoose v8)
*   **Authentication:** JWT (HMAC-SHA256) & bcryptjs
*   **Security:** Helmet, Express Rate Limit, Express Validator, CORS

---

## üîí Security Posture
*   **Rate Limiting:**
    *   `/api/auth/login`: 5 requests / minute per IP (Brute-force protection).
    *   `/api/certificates/verify`: 100 requests / minute per IP (Scraper protection).
*   **Input Sanitization:** Global regex filters drop any `<script>` or SQL injection characters before parsing.
*   **RBAC (Role-Based Access Control):** Granular middleware ensures `Clerks` vs `SuperAdmins` are isolated to their permitted routes.
*   **Internal API Bridge:** The `pythonService` uses an internal 30-second timeout Axios bridge attaching strict headers (`x-api-key: gateway-secret-token`) to secure communication with the internal mathematical Python module.
*   **Zero-Knowledge Leakage:** `dna_payload` is strictly filtered out of all API responses except when querying the Crypto Engine natively.

---

## üöÄ Deployment (Docker Compose)

The easiest way to deploy this microservice in production alongside the Crypto Engine is via Docker. 

**Prerequisites:**
*   Docker & Docker Compose installed on your VPS (Ubuntu/Debian recommended).
*   A valid MongoDB Atlas string.

**1. Create a `.env` file in the root `api-gateway` folder:**
```env
PORT=5000
MONGO_URI=mongodb+srv://<user>:<password>@cluster0.ex.mongodb.net/dna_certs?retryWrites=true&w=majority
JWT_SECRET=production-grade-super-secret-key-at-least-32-chars!
CRYPTO_ENGINE_URL=http://crypto-engine:8000
FRONTEND_URL=https://your-production-domain.com
```

**2. Deploy using Docker Compose (From the project root):**
```bash
docker-compose up -d --build
```

---

## üì° API Endpoints

### 1. Authentication (`/api/auth`)
*   `POST /register` - Registers an Admin account.
*   `POST /login` - Public endpoint. Returns a JWT.
*   `GET /profile` - Validates the Bearer token and returns current user context.

### 2. Certificates (`/api/certificates`)
*   `POST /` - Protect. Generates a new DNA Sequence via the Crypto Engine, stores record locally, and returns the QR URI.
*   `GET /` - Protect. Returns a paginated list of all certificates generated by the logged-in Administrator.
*   `GET /verify/:public_id` - Public endpoint. Extracts DNA strings from DB, validates the hash over Python bridge, and returns verified student records. Returns `403 TAMPERED` if any data bits are altered.
*   `PUT /:public_id/revoke` - Protected (SuperAdmin ONLY). Toggles revocation kill-switch on a Certificate.
